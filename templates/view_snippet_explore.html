{% extends "base.html" %}

{% block styles %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
    body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        overflow-y: auto;
        font-family: 'Manrope', sans-serif;
    }

    .main-container {
        position: relative;
        width: 100%;
        min-height: 100vh;
        padding: 3rem 0;
        background: linear-gradient(to bottom right, #f9fafb, #eef2ff, #f9fafb) no-repeat;
        background-size: cover;
    }
    .dark .main-container {
        background: linear-gradient(to bottom right, #111827, #1f2937, #111827) no-repeat;
    }

    .code-container {
        max-height: 70vh;
        overflow: auto;
        border-radius: 1rem;
        background: linear-gradient(to bottom right, #ffffff, #f8fafc);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(229, 231, 235, 0.3);
    }
    .dark .code-container {
        background: linear-gradient(to bottom right, #1f2937, #111827);
        border: 1px solid rgba(55, 65, 81, 0.3);
    }

    pre[class*="language-"] {
        background: transparent !important;
        margin: 0 !important;
        padding: 2rem !important;
        border-radius: 0 !important;
        max-height: none !important;
    }
    
    code[class*="language-"] {
        font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace !important;
        font-size: 0.9rem !important;
        line-height: 1.8 !important;
        white-space: pre !important;
        word-break: normal !important;
        word-wrap: normal !important;
        tab-size: 4 !important;
        color: #1f2937;
    }
    .dark code[class*="language-"] {
        color: #d1d5db;
    }

    .comments-section {
        margin-top: 2.5rem;
        background: linear-gradient(to bottom right, #ffffff, #f8fafc);
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(229, 231, 235, 0.3);
    }
    .dark .comments-section {
        background: linear-gradient(to bottom right, #1f2937, #111827);
        border: 1px solid rgba(55, 65, 81, 0.3);
    }

    #comments-container, .comment-thread, .nested-replies {
        height: auto;
        overflow: visible;
    }

    .comment-thread {
        margin-bottom: 2rem;
    }

    .nested-replies {
        margin-left: 1.5rem;
        border-left: 2px solid rgba(229, 231, 235, 0.3);
    }
    .dark .nested-replies {
        border-left-color: rgba(55, 65, 81, 0.3);
    }

    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: transparent;
    }
    ::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.4);
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.6);
    }

    .token.comment { color: #6A9955 !important; }
    .token.function { color: #DCDCAA !important; }
    .token.keyword { color: #569CD6 !important; }
    .token.string { color: #CE9178 !important; }
    .token.number { color: #B5CEA8 !important; }
    .token.operator { color: #D4D4D4 !important; }
    .token.class-name { color: #4EC9B0 !important; }
    .token.constant { color: #4FC1FF !important; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-12 space-y-10">
        <!-- Code Section -->
        <div class="code-container">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200/20 dark:border-gray-700/20 bg-gray-50/50 dark:bg-gray-800/50">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-100/80 dark:bg-indigo-900/80 px-4 py-1.5 rounded-full border border-indigo-200/50 dark:border-indigo-800/50 shadow-sm">{{ snippet[3] }}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 font-light">{{ snippet[2] | length }} characters</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="copy-button" class="group inline-flex items-center text-sm font-semibold text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all duration-300 ease-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto" id="code-container">
                <pre class="p-6 m-0"><code id="codeBlock" class="language-{{ snippet[3] }}">{{ snippet[2] }}</code></pre>
            </div>
        </div>

        <!-- Snippet Info -->
        <div class="rounded-xl p-6 bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800/50 shadow-lg border border-gray-200/30 dark:border-gray-700/30 backdrop-blur-sm">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4 bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 tracking-tight">{{ snippet[1] }}</h1>
            {% if snippet[4] %}
                <p class="text-gray-600 dark:text-gray-300 font-light mb-4 leading-relaxed">{{ snippet[4] }}</p>
            {% endif %}
            <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400 font-light">
                <div class="flex items-center space-x-3">
                    <span>Created by</span>
                    <a href="{{ url_for('profile', username=snippet[6]) }}" class="inline-flex items-center gap-2 group">
                        <span class="h-8 w-8 rounded-full bg-gradient-to-r from-indigo-100 to-purple-100 dark:from-indigo-800 dark:to-purple-800 text-indigo-700 dark:text-indigo-300 text-sm font-semibold flex items-center justify-center group-hover:ring-2 group-hover:ring-indigo-400 transition-all duration-200 shadow-sm">
                            {{ snippet[6][0] | upper }}
                        </span>
                        <span class="font-semibold text-gray-700 dark:text-gray-200 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{{ snippet[6] }}</span>
                    </a>
                </div>
                <span>{{ snippet[5].split(' ')[0] }}</span>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section p-6">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6 tracking-tight">Discussion</h2>
            
            {% if session['user_id'] %}
            <div class="mb-8">
                <form id="comment-form" class="space-y-4">
                    <textarea 
                        id="comment-content"
                        rows="3"
                        class="w-full px-5 py-4 rounded-xl bg-white/80 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-md transition-all duration-300 ease-out backdrop-blur-sm"
                        placeholder="Add to the discussion..."></textarea>
                    <button type="submit" 
                            class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 ease-out transform hover:scale-105">
                        Comment
                    </button>
                </form>
            </div>
            {% endif %}

            <div id="comments-container" class="space-y-6">
                {% for comment in comments %}
                <div class="comment-thread" data-comment-id="{{ comment.id }}">
                    <div class="flex space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 flex items-center justify-center shadow-md">
                                <span class="text-white font-semibold">{{ comment.username[0] | upper }}</span>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="font-semibold text-gray-900 dark:text-white">{{ comment.username }}</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400 font-light">{{ comment.created_at }}</span>
                            </div>
                            <p class="text-gray-700 dark:text-gray-300 font-light mb-3 leading-relaxed">{{ comment.content }}</p>
                            <div class="flex items-center space-x-4">
                                <button onclick="toggleReplyForm('{{ comment.id }}')" 
                                        class="text-sm text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 font-medium transition-colors duration-200">
                                    Reply
                                </button>
                            </div>
                            
                            <!-- Reply form -->
                            <div id="reply-form-{{ comment.id }}" class="mt-4 hidden">
                                <textarea 
                                    rows="2"
                                    class="w-full px-4 py-3 rounded-lg bg-white/80 dark:bg-gray-900/80 border border-gray-200/50 dark:border-gray-700/50 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 shadow-md transition-all duration-300 ease-out backdrop-blur-sm"
                                    placeholder="Write a reply..."></textarea>
                                <div class="mt-3 flex space-x-3">
                                    <button onclick="submitReply('{{ comment.id }}')" 
                                            class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-out transform hover:scale-105">
                                        Reply
                                    </button>
                                    <button onclick="toggleReplyForm('{{ comment.id }}')" 
                                            class="px-5 py-2 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-sm font-semibold rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Nested replies -->
                            {% if comment.replies %}
                            <div class="nested-replies mt-4 space-y-4">
                                {% for reply in comment.replies %}
                                <div class="flex space-x-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center shadow-sm">
                                            <span class="text-white text-sm font-semibold">{{ reply.username[0] | upper }}</span>
                                        </div>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex items-center space-x-3 mb-1">
                                            <span class="font-semibold text-gray-900 dark:text-white">{{ reply.username }}</span>
                                            <span class="text-sm text-gray-500 dark:text-gray-400 font-light">{{ reply.created_at }}</span>
                                        </div>
                                        <p class="text-gray-700 dark:text-gray-300 font-light leading-relaxed">{{ reply.content }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Navigation and Actions -->
        <div class="flex justify-between items-center py-6">
            <a href="{{ url_for('explore') }}" 
               class="inline-flex items-center text-sm font-semibold text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-300 ease-out group">
                <svg class="h-5 w-5 mr-2 group-hover:-translate-x-1 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                </svg>
                Back to Explore
            </a>
            {% if session['user_id'] %}
                <button id="share-button" 
                        class="inline-flex items-center text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors duration-300 ease-out group">
                    <svg class="h-5 w-5 mr-2 group-hover:scale-110 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                    Share
                </button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="{{ url_for('static', filename='js/view_snippet_explore.js') }}"></script>
<script>
    const snippetId = {{ snippet[0] }};
    document.addEventListener('DOMContentLoaded', () => {
        new SnippetExploreViewer(snippetId);

        const copyButton = document.getElementById('copy-button');
        const codeBlock = document.getElementById('codeBlock');
        const shareButton = document.getElementById('share-button');

        if (copyButton && codeBlock) {
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                    copyButton.innerHTML = '<svg class="h-5 w-5 mr-2 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Copied!';
                    setTimeout(() => {
                        copyButton.innerHTML = '<svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>Copy';
                    }, 2000);
                }).catch(err => console.error('Copy failed:', err));
            });
        }

        if (shareButton) {
            shareButton.addEventListener('click', () => {
                const url = window.location.href;
                const title = document.querySelector('h1').textContent;
                if (navigator.share) {
                    navigator.share({ title, url }).catch(err => console.error('Share failed:', err));
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        shareButton.innerHTML = '<svg class="h-5 w-5 mr-2 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Link Copied!';
                        setTimeout(() => {
                            shareButton.innerHTML = '<svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>Share';
                        }, 2000);
                    }).catch(err => console.error('Copy failed:', err));
                }
            });
        }
    });

    function toggleReplyForm(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        form.classList.toggle('hidden');
    }

    function submitReply(commentId) {
        const textarea = document.querySelector(`#reply-form-${commentId} textarea`);
        const content = textarea.value.trim();
        if (content) {
            fetch(`/snippet/${snippetId}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, parent_id: commentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Simple refresh; improve with dynamic DOM update if needed
                }
            })
            .catch(err => console.error('Reply failed:', err));
        }
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block head_extra %}
    {# Premium Fonts: Manrope + Inter #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">

    {# Cal-Heatmap v4 Resources #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.5/dist/cal-heatmap.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.5/dist/cal-heatmap.min.js"></script>
{% endblock %}

{% block content %}
<div class="profile-container-flat wider min-h-screen bg-gradient-to-br from-gray-50 via-white to-indigo-50/20 dark:from-gray-900 dark:via-gray-950 dark:to-indigo-900/30 text-gray-900 dark:text-gray-100 font-['Manrope',_'Inter',_sans-serif] antialiased relative isolate overflow-hidden">
    {# Premium Background: Radial Gradient + Noise #}
    <div class="absolute inset-0 -z-10 bg-[radial-gradient(ellipse_at_center,_rgba(255,255,255,0.15)_0%,_rgba(0,0,0,0)_70%)] dark:bg-[radial-gradient(ellipse_at_center,_rgba(79,70,229,0.1)_0%,_rgba(0,0,0,0)_70%)] page-texture" aria-hidden="true"></div>

    <div class="relative mx-auto px-4 sm:px-6 lg:px-12 xl:px-16 py-20 sm:py-28 max-w-screen-xl">
        {# Profile Basic Info #}
        <div class="profile-basic-info bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-indigo-950/20 border border-gray-200/30 dark:border-indigo-900/30 rounded-2xl shadow-lg p-8 mb-12 backdrop-blur-sm">
            <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
                <div class="profile-image">
                    {% if user[4] %}
                        <img src="{{ url_for('static', filename='uploads/' + user[4]) }}" alt="{{ user[1] }}'s profile picture" class="w-28 h-28 md:w-32 md:h-32 rounded-full object-cover border-4 border-indigo-300/50 dark:border-indigo-600/50 shadow-md">
                    {% else %}
                        <div class="profile-avatar-placeholder w-28 h-28 md:w-32 md:h-32 rounded-full flex items-center justify-center text-5xl font-bold text-indigo-600 dark:text-indigo-400 bg-gradient-to-br from-indigo-100 to-gray-100 dark:from-indigo-900 dark:to-gray-800 border-4 border-indigo-300/50 dark:border-indigo-600/50 shadow-md">
                            {{ user[1][0] | upper if user[1] else '?' }}
                        </div>
                    {% endif %}
                </div>
                <div class="profile-identity text-center md:text-left">
                    <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-gray-900 dark:text-white bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">
                        {{ user[1] | default('Unknown User') }}
                    </h1>
                    <p class="user-bio mt-3 text-lg text-gray-600 dark:text-gray-300 font-light leading-relaxed max-w-2xl">
                        {{ user[3] or "This user hasn’t shared a bio yet." }}
                    </p>
                    {% if 'user_id' in session and session['user_id'] != user[0] %}
                        <div class="follow-button-container mt-6" id="follow-container">
                            {% if is_following %}
                                <button id="follow-toggle-button" onclick="toggleFollow('{{ user[1] }}')" class="unfollow-button group inline-flex items-center px-6 py-3 bg-gradient-to-r from-white to-gray-50 dark:from-gray-900 dark:to-indigo-900/40 border border-gray-200/50 dark:border-indigo-800/50 text-sm font-semibold text-gray-600 dark:text-gray-300 rounded-xl shadow-md hover:shadow-lg hover:border-indigo-400/50 dark:hover:border-indigo-600/50 transition-all duration-300 ease-out transform hover:scale-[1.03] active:scale-[1.00]" data-following="true">
                                    <span class="button-icon mr-2 group-hover:rotate-12 transition-transform duration-300">✓</span> Following
                                </button>
                            {% else %}
                                <button id="follow-toggle-button" onclick="toggleFollow('{{ user[1] }}')" class="follow-button group inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 active:from-indigo-800 active:to-purple-800 text-sm font-semibold text-white rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 transition-all duration-300 ease-out transform hover:scale-[1.03] active:scale-[1.00]" data-following="false">
                                    <span class="button-icon mr-2 group-hover:rotate-12 transition-transform duration-300">+</span> Follow
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Profile Stats #}
        <div class="profile-stats grid grid-cols-2 md:grid-cols-4 gap-6 mb-16">
            {% for label, value in [('Snippets', stats[2]), ('Followers', stats[0]), ('Following', stats[1]), ('Total Upvotes', stats[3])] %}
                <div class="stat-box bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-indigo-950/20 border border-gray-200/30 dark:border-indigo-900/30 rounded-xl p-6 text-center shadow-md hover:shadow-lg transition-all duration-300 ease-out backdrop-blur-sm">
                    <span class="stat-number text-3xl font-semibold text-gray-900 dark:text-white bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">{{ value | default(0) }}</span>
                    <span class="stat-label block mt-2 text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400 font-medium">{{ label }}</span>
                </div>
            {% endfor %}
        </div>

        {# Contribution Calendar Section #}
        <div class="contribution-section bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-indigo-950/30 border border-gray-200/30 dark:border-indigo-900/30 rounded-2xl shadow-lg p-8 mb-16 backdrop-blur-sm">
            <h2 class="contribution-heading text-2xl font-semibold text-gray-900 dark:text-white mb-6 tracking-tight">Contribution Activity</h2>
            <div id="contribution-calendar" class="overflow-x-auto pb-4">
                <div class="calendar-loading text-gray-500 dark:text-gray-400 font-light text-center py-12">Loading activity...</div>
            </div>
            <div class="contribution-legend flex justify-end items-center gap-3 mt-4 text-sm text-gray-500 dark:text-gray-400 font-light">
                Less
                <span class="legend-box w-4 h-4 rounded-sm border border-gray-200/50 dark:border-indigo-900/50" style="background-color: var(--cal-color-L1);"></span>
                <span class="legend-box w-4 h-4 rounded-sm border border-gray-200/50 dark:border-indigo-900/50" style="background-color: var(--cal-color-L2);"></span>
                <span class="legend-box w-4 h-4 rounded-sm border border-gray-200/50 dark:border-indigo-900/50" style="background-color: var(--cal-color-L3);"></span>
                <span class="legend-box w-4 h-4 rounded-sm border border-gray-200/50 dark:border-indigo-900/50" style="background-color: var(--cal-color-L4);"></span>
                More
            </div>
        </div>

        {# Snippets Section #}
        <h2 class="snippets-heading text-3xl font-semibold text-gray-900 dark:text-white mb-8 tracking-tight border-b border-gray-200/30 dark:border-indigo-900/30 pb-4">Public Snippets</h2>
        {% if snippets %}
            <ul class="snippet-list space-y-6">
                {% for snippet in snippets %}
                    <li class="snippet-list-item group bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-indigo-950/30 border border-gray-200/30 dark:border-indigo-900/30 rounded-xl p-6 shadow-md hover:shadow-xl hover:border-indigo-300/50 dark:hover:border-indigo-600/50 transition-all duration-300 ease-out backdrop-blur-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                            <div class="snippet-list-main flex-1">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                                    <a href="{{ url_for('view_snippet_explore', id=snippet[0]) }}" class="group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors focus:outline-none focus-visible:underline focus-visible:decoration-indigo-500">
                                        {{ snippet[1] | default('Untitled Snippet') }}
                                    </a>
                                </h3>
                                <div class="snippet-meta mt-2 flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400 font-light">
                                    <span class="language inline-flex items-center px-3 py-1 bg-indigo-100/80 dark:bg-indigo-900/80 text-indigo-700 dark:text-indigo-300 rounded-full font-medium border border-indigo-200/50 dark:border-indigo-800/50">
                                        {{ snippet[2] | default('Unknown') }}
                                    </span>
                                    <span class="date">{{ snippet[3][:10] if snippet[3] else 'N/A' }}</span>
                                    <span class="views">{{ snippet_views_map[snippet[0]] | default(0) }} views</span>
                                </div>
                            </div>
                            <div class="snippet-list-aside flex items-center gap-6">
                                <div class="vote-stats flex gap-4 text-sm font-medium">
                                    <span class="upvotes text-emerald-600 dark:text-emerald-400">↑ {{ snippet[4] | default(0) }}</span>
                                    <span class="downvotes text-rose-600 dark:text-rose-400">↓ {{ snippet[5] | default(0) }}</span>
                                </div>
                                <a href="{{ url_for('view_snippet_explore', id=snippet[0]) }}" class="view-button-small group/link inline-flex items-center px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-out transform hover:scale-[1.03]">
                                    View
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 group-hover/link:translate-x-1 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
                                </a>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="no-snippets text-center py-20 bg-gradient-to-br from-white to-indigo-50/20 dark:from-gray-900 dark:to-indigo-900/30 rounded-2xl border border-gray-200/30 dark:border-indigo-900/30 shadow-lg mt-8 backdrop-blur-sm">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="no-snippets-icon mx-auto text-indigo-400 dark:text-indigo-500">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <p class="mt-4 text-lg text-gray-600 dark:text-gray-300 font-light">{{ user[1] | default('This user') }} hasn’t posted any public snippets yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
/* Premium CSS Variables */
:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-accent: #4f46e5;
    --text-on-accent: #ffffff;
    --border-color: rgba(229, 231, 235, 0.3);
    --shadow-color: rgba(0, 0, 0, 0.05);
    --success-color: #10b981;
    --danger-color: #ef4444;
    --lang-bg: rgba(224, 231, 255, 0.8);
    --lang-text: #4338ca;
    --cal-bg: #ffffff;
    --cal-text: #64748b;
    --cal-border: rgba(229, 231, 235, 0.3);
    --cal-day-bg: #ebedf0;
    --cal-day-border: rgba(229, 231, 235, 0.5);
    --cal-color-L1: #c6e48b;
    --cal-color-L2: #7bc96f;
    --cal-color-L3: #239a3b;
    --cal-color-L4: #196127;
    --cal-tooltip-bg: #24292e;
    --cal-tooltip-text: #ffffff;
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --text-accent: #818cf8;
        --text-on-accent: #ffffff;
        --border-color: rgba(55, 65, 81, 0.3);
        --shadow-color: rgba(0, 0, 0, 0.2);
        --success-color: #34d399;
        --danger-color: #f87171;
        --lang-bg: rgba(55, 65, 81, 0.8);
        --lang-text: #9ca3af;
        --cal-bg: #1f2937;
        --cal-text: #9ca3af;
        --cal-border: rgba(55, 65, 81, 0.3);
        --cal-day-bg: #2d333b;
        --cal-day-border: #444c56;
        --cal-color-L1: #0e4429;
        --cal-color-L2: #006d32;
        --cal-color-L3: #26a641;
        --cal-color-L4: #39d353;
        --cal-tooltip-bg: #c9d1d9;
        --cal-tooltip-text: #1e293b;
    }
    img { filter: brightness(.9) contrast(1); }
}

/* General Styles */
body {
    color: var(--text-primary);
    background-color: transparent;
    margin: 0;
    padding: 0;
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
}
a { color: var(--text-accent); text-decoration: none; transition: color 0.2s ease; }
a:hover { color: var(--primary-hover); }

/* Profile Container */
.profile-container-flat.wider {
    max-width: none;
}

/* Profile Basic Info */
.profile-basic-info { border-bottom: none; }

/* Contribution Calendar */
.contribution-section {
    transition: all 0.3s ease-out;
}
.cal-heatmap-container .graph-rect {
    fill: var(--cal-day-bg);
    stroke: var(--cal-day-border);
    stroke-width: 1px;
    rx: 3px;
    ry: 3px;
    transition: fill 0.3s ease;
}
.cal-heatmap-container .graph-rect[data-level='1'] { fill: var(--cal-color-L1); }
.cal-heatmap-container .graph-rect[data-level='2'] { fill: var(--cal-color-L2); }
.cal-heatmap-container .graph-rect[data-level='3'] { fill: var(--cal-color-L3); }
.cal-heatmap-container .graph-rect[data-level='4'] { fill: var(--cal-color-L4); }
.cal-heatmap-container .graph-label {
    fill: var(--cal-text);
    font-size: 11px;
    font-family: 'Manrope', 'Inter', sans-serif;
}
.cal-heatmap-container .graph-subdomain-group:hover .graph-rect {
    stroke: var(--text-accent);
    stroke-width: 2px;
}
.ch-tooltip {
    background: var(--cal-tooltip-bg) !important;
    color: var(--cal-tooltip-text) !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 13px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    border: none !important;
    font-family: 'Manrope', 'Inter', sans-serif !important;
}

/* Snippet List */
.snippet-list-item { transition: all 0.3s ease-out; }

/* Responsive */
@media (max-width: 768px) {
    .profile-container-flat.wider { padding: 0 16px; }
    .profile-stats { grid-template-columns: 1fr 1fr; gap: 4; }
    .snippet-list-item { padding: 20px; }
}

@media (max-width: 480px) {
    .profile-stats { grid-template-columns: 1fr; }
    .stat-box { padding: 12px; }
}
</style>

<script>
async function toggleFollow(username) {
    const button = document.getElementById('follow-toggle-button');
    if (!button || button.classList.contains('loading')) return;
    const isCurrentlyFollowing = button.getAttribute('data-following') === 'true';
    const actionUrl = isCurrentlyFollowing ? `/unfollow/${username}` : `/follow/${username}`;
    button.classList.add('loading');
    button.disabled = true;
    try {
        const response = await fetch(actionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();
        if (response.ok && data.success) {
            const wasFollowing = isCurrentlyFollowing;
            button.setAttribute('data-following', String(!wasFollowing));
            if (wasFollowing) {
                button.classList.remove('unfollow-button');
                button.classList.add('follow-button');
                button.innerHTML = '<span class="button-icon mr-2 group-hover:rotate-12 transition-transform duration-300">+</span> Follow';
                button.className = button.className.replace('from-white to-gray-50 dark:from-gray-900 dark:to-indigo-900/40 border-gray-200/50 dark:border-indigo-800/50 text-gray-600 dark:text-gray-300', 'from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 active:from-indigo-800 active:to-purple-800 text-white');
            } else {
                button.classList.remove('follow-button');
                button.classList.add('unfollow-button');
                button.innerHTML = '<span class="button-icon mr-2 group-hover:rotate-12 transition-transform duration-300">✓</span> Following';
                button.className = button.className.replace('from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 active:from-indigo-800 active:to-purple-800 text-white', 'from-white to-gray-50 dark:from-gray-900 dark:to-indigo-900/40 border border-gray-200/50 dark:border-indigo-800/50 text-gray-600 dark:text-gray-300');
            }
        } else {
            console.error("Follow/Unfollow failed:", data.message);
            alert(`Action failed: ${data.message || 'Please try again.'}`);
        }
    } catch (error) {
        console.error('Network or JS error:', error);
        alert('An error occurred. Please check your connection and try again.');
    } finally {
        button.classList.remove('loading');
        button.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const calContainer = document.getElementById('contribution-calendar');
    const profileUsername = {{ profile_username | tojson | safe }};

    if (calContainer && profileUsername) {
        fetch(`/api/user/${profileUsername}/contributions`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.contributions) {
                    calContainer.innerHTML = '';
                    const heatmapData = {};
                    for (const [dateStr, count] of Object.entries(data.contributions)) {
                        heatmapData[dateStr] = count;
                    }

                    const cal = new CalHeatmap();
                    cal.paint({
                        data: { source: heatmapData, x: 'date', y: 'count' },
                        date: { start: new Date(new Date().setFullYear(new Date().getFullYear() - 1)) },
                        range: 12,
                        scale: {
                            color: {
                                type: 'threshold',
                                domain: [1, 3, 6, 10],
                                range: [
                                    getComputedStyle(document.documentElement).getPropertyValue('--cal-color-L1').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--cal-color-L2').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--cal-color-L3').trim(),
                                    getComputedStyle(document.documentElement).getPropertyValue('--cal-color-L4').trim()
                                ]
                            }
                        },
                        domain: { type: 'month', padding: [12, 12, 12, 12], label: { text: 'MMM', textAlign: 'start', position: 'top' }, gutter: 6 },
                        subDomain: { type: 'day', width: 14, height: 14, radius: 3, gutter: 4 },
                        itemSelector: '#contribution-calendar'
                    });
                } else {
                    calContainer.innerHTML = `<div class="calendar-loading error text-gray-500 dark:text-gray-400 font-light text-center py-12">${data.error || 'Could not load activity data.'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching contributions:', error);
                calContainer.innerHTML = `<div class="calendar-loading error text-gray-500 dark:text-gray-400 font-light text-center py-12">Error loading activity chart.</div>`;
            });
    }
});
</script>
{% endblock %}